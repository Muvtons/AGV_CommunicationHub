#include <AGV_CommunicationHub.h>

// 1. Create instance (global)
AGV_CommunicationHub commHub;

// 2. Command handler function (called when commands arrive)
void onCommandReceived(const char* command, uint8_t source, uint8_t priority) {
  // source: 0 = web interface, 1 = serial monitor
  // priority: 0 = normal, 1 = emergency (STOP/ABORT)
  
  Serial.printf("[APP] Processing command: %s (source=%d, priority=%d)\n", 
                command, source, priority);
  
  // Example: Forward commands to motor control system
  if (priority == 1 && (strstr(command, "STOP") || strstr(command, "ABORT"))) {
    // Execute emergency stop immediately (your motor code here)
    Serial.println("!!! EMERGENCY STOP ACTIVATED !!!");
  }
  
  // For demonstration, just echo back status
  String status = "Executing: ";
  status += command;
  commHub.sendStatus(status.c_str());
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  // 3. Initialize communication hub with device name and credentials
  commHub.begin("my_agv_controller", "admin", "secure123");
  
  // 4. Register command callback (this connects the communication to your motor control)
  commHub.setCommandCallback(onCommandReceived);
  
  Serial.println("\nâœ… System ready! Communication hub running on Core 0");
  Serial.println("ðŸŒ Web interface: http://my_agv_controller.local");
  Serial.println("âŒ¨ï¸  Serial commands: move forward, turn_left 90, STOP, etc.");
  
  // Core 1 motor control code would start here (in separate task)
}

void loop() {
  // NO CODE NEEDED HERE! The library runs in its own FreeRTOS task on Core 0
  // Your Core 1 code would run here (motor control, sensors, etc.)
  
  // Optional: Send periodic status updates
  static unsigned long lastStatus = 0;
  if (millis() - lastStatus > 5000) {
    commHub.sendStatus("AGV Ready - Idle");
    lastStatus = millis();
  }
  
  delay(100);
}